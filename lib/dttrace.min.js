!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Dttrace=t()}(this,function(){"use strict";var e=function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var a=n[r];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(t))return decodeURIComponent(a.substring(t.length,a.length))}return null},t=function(){for(var e=1*new Date,t=0;e==1*new Date;)t++;return e.toString(16)+t.toString(16)};function n(){var e=(screen.height*screen.width).toString(16);return t()+"-"+Math.random().toString(16).replace(".","")+"-"+function(){var e,t,n=navigator.userAgent,a=[],r=0,o=function(e,t){var n,r=0;for(n=0;n<t.length;n++)r|=a[n]<<8*n;return e^r};for(e=0;e<n.length;e++)t=n.charCodeAt(e),a.unshift(255&t),4<=a.length&&(r=o(r,a),a=[]);return 0<a.length&&(r=o(r,a)),r.toString(16)}()+"-"+e+"-"+t()}var r=global.localStorage,s=function(){var e=f().session_expiration_time;if(""===document.referrer||document.referrer.indexOf(location.host)<0){var t=n();!function(e,t,n,r,a){var o="",i="",c="";if(r){var s=document.location.hostname.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,6}$/i),u=s?s[0]:"";o=u?"; domain=."+u:""}if(n){var l=new Date;l.setTime(l.getTime()+n),i="; expires="+l.toGMTString()}a&&(c="; secure"),document.cookie=e+"="+encodeURIComponent(t)+i+"; path=/"+o+c}("DTTRACE_SESSIONID",t,e),r.setItem("DTTRACE_SESSIONID",t)}},a=global.screen,o=global.location,i=global.navigator,c=function(){return Object.assign({},a&&{$screen_height:a.height,$screen_width:a.width,$screen_colordepth:a.colorDepth},o&&{$url:o.href,$url_path:o.pathname},i&&{$lang:i.language,$user_agent:i.userAgent},document&&{$title:document.title,$referrer:document.referrer,$referrer_host:function(e){var t=/:\/\/.*\//;if(t.test(e))return e.match(t)[0].replace(/(:\/\/)|(\/)/g,"")}(document.referrer),$cookie:document.cookie},{$sessionId:e("DTTRACE_SESSIONID")?e("DTTRACE_SESSIONID"):r.getItem("DTTRACE_SESSIONID")?r.getItem("DTTRACE_SESSIONID"):void 0})},u=Object.assign({},c(),{$DTTID:n()}),l={url:"https://recvapi.md.dtstack.com/dta",session_expiration_time:18e5},d=function(){return Object.assign(u,c()),u},g=function(e){return Object.assign(u,e),u},f=function(){return l},m=function(e){var t=f(),n=Object.assign({},d(),e);if(t.url){var r=function(e){var t="";for(var n in e)""!=t&&(t+="&"),t+=n+"="+encodeURIComponent(e[n]);return t}(n);r+="&timestamp="+toISOString(),new Image(1,1).src=t.url+"?"+r}else console.error("未调用Dta.options.setDefaultOptions设置url参数")};var p=function(){var n=[],r=!1;function e(e){var t=e||global.event;r||"onreadystatechange"===t.type&&"complete"!==document.readyState||(n.forEach(function(e){e.call(document)}),r=!0,n=[])}return document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),global.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),global.attachEvent("onload",e)),function(e){r?e.call(document):n.push(e)}}(),v=function(e){if(!e.preventDefault)return{};var t=e.target||e.srcElement;return{$element_id:t.id,$element_name:t.name,$element_content:t.innerHTML,$element_class_name:t.className,$element_type:t.nodeName,$element_target_url:t.href,$screenX:e.screenX,$screenY:e.screenY}},h=function(e,t,n,r){return e.addEventListener?(e.addEventListener(t,n,r),!0):e.attachEvent?e.attachEvent("on"+t,n):void(e["on"+t]=n)};return{init:function(e){var t,a=e.appKey,n=e.appType,r=e.token,o=e.session_expiration_time,i=e.params;function c(e){e.ppKey;var t=e.appType,n=e.token,r=[];return a||r.push("appKey no exist"),t||r.push("appType no exist"),n||r.push("token no exist"),r}0<c(e).length?(o&&(t={session_expiration_time:o},Object.assign(l,t)),g(Object.assign({},{$app_key:a,$app_type:n,$token:r},i)),p(function(){var t=(new Date).getTime();s();var e=function(){m({trigger_type:"enter"})};h(global,"load",e,!1),h(global,"pageshow",e,!1);var n=document.getElementsByTagName("body")[0];h(n,"click",function(e){var t=global.event||e,n=t.target||t.srcElement;if(-1<n.className.indexOf("dttrace")){var r={};Object.keys(n.dataset).filter(function(e){-1<e.indexOf("dttrace")&&(r[e.substring(3).charAt(0).toLocaleLowerCase()+e.substring(4)]=n.dataset[e])}),m(Object.assign({},v(t),r))}},!1);var r=function(){var e=(new Date).getTime();m({trigger_type:"leave",stay_time:e-t})};h(global,"beforeunload",r,!1),h(global,"pagehide",r,!1)})):(console.error("Dttrace initialize unsuccessfully,some required params no exist!"),c(e).forEach(function(e){console.error(e)}))},launchRocket:function(e,t){var n=e;t&&Object.assign(n,v(t)),m(n)},carryRocket:function(r,a){r.length;return function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var n=global.event?global.event:arg0;r.apply(void 0,e),m(Object.assign({},v(n),a))}},DttraceRocket:DttraceRocket,setDefaultParams:g,removeDefaultParams:function(e){var t=u[e];return delete u[e],t},getDefaultParams:d}});
