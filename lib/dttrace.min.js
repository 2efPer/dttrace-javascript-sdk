!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Dttrace=t()}(this,function(){"use strict";var t={url:window.location.protocol+"//recvapi.md.dtstack.com/dta/",session_expiration:18e5,status:1},c=function(e){return e?t[e]:t},s=function(e){return Object.assign(t,e),t},n=function(){for(var e=1*new Date,t=0;e==1*new Date;)t++;return e.toString(16)+t.toString(16)};function o(){var e=(screen.height*screen.width).toString(16);return n()+"-"+Math.random().toString(16).replace(".","")+"-"+function(){var e,t,n=navigator.userAgent,o=[],r=0,a=function(e,t){var n,r=0;for(n=0;n<t.length;n++)r|=o[n]<<8*n;return e^r};for(e=0;e<n.length;e++)t=n.charCodeAt(e),o.unshift(255&t),4<=o.length&&(r=a(r,o),o=[]);return 0<o.length&&(r=a(r,o)),r.toString(16)}()+"-"+e+"-"+n()}var e=function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var o=n[r];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return decodeURIComponent(o.substring(t.length,o.length))}return null},a=function(e,t,n,r,o){var a="",i="",c="";if(r){var s=document.location.hostname.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,6}$/i),u=s?s[0]:"";a=u?"; domain=."+u:""}if(n){var d=new Date;d.setTime(d.getTime()+n),i="; expires="+d.toGMTString()}o&&(c="; secure"),document.cookie=e+"="+encodeURIComponent(t)+i+"; path=/"+a+c},i=window.localStorage,r=window.screen,u=window.location,d=window.navigator;function f(){return Object.assign({},r&&{$screen_height:r.height,$screen_width:r.width,$screen_colordepth:r.colorDepth},u&&{$url:u.href,$url_path:u.pathname+u.hash},d&&{$lang:d.language,$user_agent:d.userAgent},document&&{$title:document.title,$referrer:document.referrer,$referrer_host:function(e){var t=/:\/\/.*\//;if(t.test(e))return e.match(t)[0].replace(/(:\/\/)|(\/)/g,"")}(document.referrer),$cookie:document.cookie},{$session_id:e("DTTRACE_SESSIONID")?e("DTTRACE_SESSIONID"):i.getItem("DTTRACE_SESSIONID")?i.getItem("DTTRACE_SESSIONID"):void 0,$app_key:c("appKey"),$app_type:c("appType"),$token:c("token")})}var g=Object.assign({},f(),{$DTTID:o()}),l={get:function(e){return Object.assign(g,f()),e?g[e]:g},set:function(e){return Object.assign(g,e),g},remove:function(e){return Object.assign(g,f()),g[e]}},p=function(e){var t=c(),n=Object.assign({},l.get(),e);if(t.status){if(!e.$trigger_type)return void console.error(new Error("$trigger_type not exist in params"));var r=function(e){var t="";for(var n in e)""!=t&&(t+="&"),e[n]&&(t+=n+"="+encodeURIComponent(e[n]));return t}(n);r+="&$timestamp="+(new Date).getTime(),new Image(1,1).src=t.url+"?"+r}else console.error(new Error("Dttrace not init,please excute Dttrace.init"))};var m=function(){var n=[],r=!1;function e(e){var t=e||window.event;r||"onreadystatechange"===t.type&&"complete"!==document.readyState||(n.forEach(function(e){e.call(document)}),r=!0,n=[])}return document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),window.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),window.attachEvent("onload",e)),function(e){r?e.call(document):n.push(e)}}(),v=function(e){if(!e.preventDefault)return{};var t=e.target||e.srcElement;return{$element_id:t.id,$element_name:t.name,$element_content:t.innerHTML,$element_class_name:t.className,$element_type:t.nodeName,$element_target_url:t.href,$screenX:e.screenX,$screenY:e.screenY}},h=function(e,t,n,r){return e.addEventListener?(e.addEventListener(t,n,r),!0):e.attachEvent?e.attachEvent("on"+t,n):void(e["on"+t]=n)};function w(){m(function(){var t=(new Date).getTime();!function(){var e=c().session_expiration;if(""===document.referrer||document.referrer.indexOf(location.host)<0){var t=o();a("DTTRACE_SESSIONID",t,e),i.setItem("DTTRACE_SESSIONID",t)}}();var e=function(){p({$trigger_type:"enter"})};"onpageshow"in window?h(window,"pageshow",e,!1):h(window,"load",e,!1);var n=document.getElementsByTagName("body")[0];h(n,"click",function(e){var t=window.event||e,n=t.target||t.srcElement;if(-1<n.className.indexOf("dttrace")){var r={};Object.keys(n.dataset).filter(function(e){-1<e.indexOf("dttrace")&&(r[e.substring(7).toLocaleLowerCase()]=n.dataset[e])}),p(Object.assign({},v(t),r))}},!1);var r=function(){var e=(new Date).getTime();p({$trigger_type:"leave",$stay_time:e-t})};"onpagehide"in window?h(window,"pagehide",r,!1):h(window,"beforeunload",r,!1)})}function E(o,a){if("function"==typeof o){o.length;return function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var n=window.event?window.event:arg0,r=o.apply(this,e);p(Object.assign({},v(n),a,r))}}console.error(new Error("first param in Dttrace.carryRocket must be function"))}return{init:function(e){var t=e.appKey,n=e.appType,r=e.token,o=e.sessionExpiration,a=e.params;try{if(!t)throw new Error("appKey no exist");if(!n)throw new Error("appType no exist");if(!r)throw new Error("token no exist")}catch(e){s({status:0}),console.error(e)}if(c("status")){var i={appKey:t,appType:n,token:r};o&&Object.assign(i,{session_expiration:o}),s(i),l.set(a),w()}},launchRocket:function(e,t){var n=e;t&&Object.assign(n,v(t)),p(n)},carryRocket:E,DttraceRocket:function(r){return function(e,t,n){return e[t]=E(e[t],r),e}},Param:l}});
