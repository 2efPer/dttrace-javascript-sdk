!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Dttrace=t()}(this,function(){"use strict";var e=function(e){for(var t=e+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var o=n[r];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return decodeURIComponent(o.substring(t.length,o.length))}return null},t=function(){for(var e=1*new Date,t=0;e==1*new Date;)t++;return e.toString(16)+t.toString(16)};function n(){var e=(screen.height*screen.width).toString(16);return t()+"-"+Math.random().toString(16).replace(".","")+"-"+function(){var e,t,n=navigator.userAgent,o=[],r=0,a=function(e,t){var n,r=0;for(n=0;n<t.length;n++)r|=o[n]<<8*n;return e^r};for(e=0;e<n.length;e++)t=n.charCodeAt(e),o.unshift(255&t),4<=o.length&&(r=a(r,o),o=[]);return 0<o.length&&(r=a(r,o)),r.toString(16)}()+"-"+e+"-"+t()}var r=window.localStorage,c=function(){var e=l().session_expiration;if(""===document.referrer||document.referrer.indexOf(location.host)<0){var t=n();!function(e,t,n,r,o){var a="",i="",c="";if(r){var s=document.location.hostname.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,6}$/i),u=s?s[0]:"";a=u?"; domain=."+u:""}if(n){var d=new Date;d.setTime(d.getTime()+n),i="; expires="+d.toGMTString()}o&&(c="; secure"),document.cookie=e+"="+encodeURIComponent(t)+i+"; path=/"+a+c}("DTTRACE_SESSIONID",t,e),r.setItem("DTTRACE_SESSIONID",t)}},o=window.screen,a=window.location,i=window.navigator,s=function(){return Object.assign({},o&&{$screen_height:o.height,$screen_width:o.width,$screen_colordepth:o.colorDepth},a&&{$url:a.href,$url_path:a.pathname+a.hash},i&&{$lang:i.language,$user_agent:i.userAgent},document&&{$title:document.title,$referrer:document.referrer,$referrer_host:function(e){var t=/:\/\/.*\//;if(t.test(e))return e.match(t)[0].replace(/(:\/\/)|(\/)/g,"")}(document.referrer),$cookie:document.cookie},{$session_id:e("DTTRACE_SESSIONID")?e("DTTRACE_SESSIONID"):r.getItem("DTTRACE_SESSIONID")?r.getItem("DTTRACE_SESSIONID"):void 0})},u=Object.assign({},s(),{$DTTID:n()}),d={url:"https://recvapi.md.dtstack.com/dta/",session_expiration:18e5,status:0},f=function(e){return Object.assign(u,e),u},l=function(){return d},g=function(e){return Object.assign(d,e),d},m=function(e){var t=l(),n=Object.assign({},(Object.assign(u,s()),u),e);if(t.status){var r=function(e){var t="";for(var n in e)""!=t&&(t+="&"),e[n]&&(t+=n+"="+encodeURIComponent(e[n]));return t}(n);r+="&$timestamp="+(new Date).getTime(),new Image(1,1).src=t.url+"?"+r}else console.error("Dttrace not init,please excute Dttrace.init")};var p=function(){var n=[],r=!1;function e(e){var t=e||window.event;r||"onreadystatechange"===t.type&&"complete"!==document.readyState||(n.forEach(function(e){e.call(document)}),r=!0,n=[])}return document.addEventListener?(document.addEventListener("DOMContentLoaded",e,!1),document.addEventListener("readystatechange",e,!1),window.addEventListener("load",e,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",e),window.attachEvent("onload",e)),function(e){r?e.call(document):n.push(e)}}(),h=function(e){if(!e.preventDefault)return{};var t=e.target||e.srcElement;return{$element_id:t.id,$element_name:t.name,$element_content:t.innerHTML,$element_class_name:t.className,$element_type:t.nodeName,$element_target_url:t.href,$screenX:e.screenX,$screenY:e.screenY}},v=function(e,t,n,r){return e.addEventListener?(e.addEventListener(t,n,r),!0):e.attachEvent?e.attachEvent("on"+t,n):void(e["on"+t]=n)};var w=function(o,a){if("function"==typeof o){o.length;return function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];var n=window.event?window.event:arg0,r=o.apply(this,e);m(Object.assign({},h(n),Object.assign({$trigger_type:"action"},a),r))}}console.error("Dttrace.carryRocket参数传递错误")};return{init:function(e){var t=e.appKey,n=e.appType,r=e.token,o=e.sessionExpiration,a=e.params;function i(e){var t=e.appKey,n=e.appType,r=e.token,o=[];return t||o.push("appKey no exist"),n||o.push("appType no exist"),r||o.push("token no exist"),o}0<i(e).length?(console.error("Dttrace initialize unsuccessfully,some required params no exist!"),i(e).forEach(function(e){console.error(e)})):(o&&g({session_expiration:o}),f(Object.assign({},{$app_key:t,$app_type:n,$token:r},a)),p(function(){var t=(new Date).getTime();c();var e=function(){m({$trigger_type:"enter"})};"onpageshow"in window?v(window,"pageshow",e,!1):v(window,"load",e,!1);var n=document.getElementsByTagName("body")[0];v(n,"click",function(e){var t=window.event||e,n=t.target||t.srcElement;if(-1<n.className.indexOf("dttrace")){var r={};Object.keys(n.dataset).filter(function(e){-1<e.indexOf("dttrace")&&(r[e.substring(7).toLocaleLowerCase()]=n.dataset[e])}),m(Object.assign({$trigger_type:"action"},h(t),r))}},!1);var r=function(){var e=(new Date).getTime();m({$trigger_type:"leave",$stay_time:e-t})};"onpagehide"in window?v(window,"pagehide",r,!1):v(window,"beforeunload",r,!1),g({status:1})}))},launchRocket:function(e,t){var n=e;t&&Object.assign(n,h(t)),m(n)},carryRocket:w,DttraceRocket:function(r){return function(e,t,n){return e[t]=w(e[t],r),e}},setDefaultParams:f,removeDefaultParams:function(e){var t=u[e];return delete u[e],t}}});
